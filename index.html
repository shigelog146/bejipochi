<!DOCTYPE html>
<html lang="ja">
  <!--head head head head head head head head head head head head head head headã€€ã¯ã˜ã¾ã‚Š-->
<head>
<meta charset="UTF-8">
<title>é‡èœç™»éŒ²ï¼ˆè¾²å®¶ç”¨ï¼‰</title>
<style>
  /* é«˜é½¢è€…ãƒ»ã‚¹ãƒãƒ›å‘ã‘ã«å¤§ãã‚è¡¨ç¤º */
  body {
    font-size: 20px;
    font-family: sans-serif;
    padding: 16px;
    background-color: #e4e3e3;
  }

  h1 {
    font-size: 26px;
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-top: 16px;
    font-weight: bold;
  }

  input, textarea {
    width: 100%;
    font-size: 20px;
    padding: 10px;
    margin-top: 6px;
  }

  /* ãƒœã‚¿ãƒ³ï¼šæœ€å¤§æ¨ª 5cmã€å·¦å¯„ã› */
  button {
    width: auto;              /* è‡ªå‹•å¹… */
    max-width: 5cm;           /* æœ€å¤§ 5cm */
    font-size: 20px;
    padding: 10px;
    margin: 24px 0;           /* å·¦å¯„ã›ï¼ˆauto ã‚’ä½¿ã‚ãªã„ï¼‰ */
    background: rgb(26, 87, 26);
    color: white;
    border: none;
    border-radius: 3px;

    /* ç«‹ä½“æ„Ÿ */
    /*box-shadow: 0 4px 0 #225d0b;
    transition: all 0.1s ease;*/
  }

  /* æŠ¼ã—ã¦ã„ã‚‹é–“ */
  button:active {
    transform: translateY(3px);
    box-shadow: 0 1px 0 #0b5d0b;
  }
  /* ãƒ›ãƒãƒ¼ã€€*/
  button:hover { background-color: #488e48;
  }

  .file-label {
    display: inline-block;
    background: #0b5d0b;
    color: white;
    padding: 12px 16px;
    border-radius: 2px;
    font-size: 16px;
    cursor: pointer;
  }

  /* inputæœ¬ä½“ã¯éš ã™ */
  .file-label input {
    display: none;
  }

  #photoPreview {
    margin-top: 16px;
    width: 100%;
    max-width: 320px;
    height: 240px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fafafa;
  }

  #photoPreview img {
    max-width: 100%;
    max-height: 100%;
    border-radius: 6px;
  }

  /* æ¨ªä¸¦ã³ */
  .coord-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .coord-item {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 150px;
  }

  .coord-item label {
    margin-bottom: 4px;
  }

  .coord-item input {
    padding: 6px;
    width: 100%;
    box-sizing: border-box;
  }

  #loginPanel {
  position: fixed;
  top: 10px;
  right: 10px;
  background: white;
  padding: 10px;
  border-radius: 3px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  z-index: 1000;
  width: 270px;
}

#loginPanel input {
  width: 100%;
  margin-bottom: 5px;
}

.hidden {
  display: none;
}

.locked {
  pointer-events: none;
  opacity: 0.4;
}

#loginPanel,
#loginPanel * {
  box-sizing: border-box;
}

#loginPanel input {
  width: 100%;
  margin-bottom: 8px;
  font-size: 16px;
}

/* =========================
   ç”»é¢ãŒå°ã•ã„ç«¯æœ«å‘ã‘èª¿æ•´
   ========================= */
@media (max-width: 600px) {

  /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ */
  #appArea {
    padding: 8px;
  }

  /* ãƒ©ãƒ™ãƒ«æ–‡å­—ã‚’å°‘ã—å°ã•ã */
  label {
    font-size: 14px;
  }

  /* å…¥åŠ›æ¬„ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
  input,
  textarea {
    font-size: 14px;
    padding: 6px;
  }

  /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  #photoPreview img {
    max-width: 100%;
    height: auto;
  }

  /* ç™»éŒ²ãƒœã‚¿ãƒ³ */
  button {
    font-size: 14px;
    padding: 8px;
  }
}

#map{
  width: 100%;
  max-width: 320px;
  height: 240px;
  border: 2px dashed #ccc;
  border-radius: 8px;
  margin-top: 16px;
}

</style>

<script src="https://unpkg.com/lucide@latest"></script>

<!--åœ°å›³ãƒªãƒ³ã‚¯-->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!--åœ°å›³ãƒªãƒ³ã‚¯-->

</head>
  <!--head head head head head head head head head head head head head head headã€€ãŠã‚ã‚Šã€€-->
  <!--body body body body body body body body body body body body body body bodyã€€ã¯ã˜ã¾ã‚Š--> 
<body>
<!-- ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ãƒãƒ« -->
<div id="loginPanel">
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">

  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">ç™»éŒ²</button>
  <button onclick="logout()" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <span id="loginStatus"></span>
</div>
<!-- â˜… æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨éƒ¨ã“ã“ã«å…¥ã‚Œã‚‹ ã¯ã˜ã¾ã‚Š-->
<div id="appArea" class="locked">

  <!-- â†“â†“â†“ ã“ã“ã«ä»Šã¾ã§ã®é‡èœç™»éŒ²HTMLã‚’ãã®ã¾ã¾ â†“â†“â†“ -->
  <!--ï¼ˆfarm_name / ç·¯åº¦çµŒåº¦ / å†™çœŸ / ç™»éŒ²ãƒœã‚¿ãƒ³ etcï¼‰-->
  <!-- â†‘â†‘â†‘ å¤‰æ›´ãªã— â†‘â†‘â†‘ -->

<h1>æœ¬æ—¥ã®é‡èœã‚’ç™»éŒ²</h1>

<label>ç•‘ã®åå‰</label>
<input id="farm_name" placeholder="ä¾‹ï¼šå±±ç”°è¾²åœ’ ç¬¬1ç•‘">

<label>ç•‘ã®ä½ç½®</label>
<button type="button" onclick="getCurrentLocation()">
  <i data-lucide="carrot"></i> ä»Šã„ã‚‹å ´æ‰€
</button>

<script>
  // DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹
  window.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
  });

  // ä½ç½®å–å¾—ã®é–¢æ•°ï¼ˆä¸­èº«ã¯ç©ºã§ã‚‚å®šç¾©ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
  function getCurrentLocation() {
    console.log("ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...");
  }
</script>

  <!-- ç·¯åº¦ãƒ»çµŒåº¦ã®å…¥åŠ›æ¬„ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
  <div class="coord-row">
    <div class="coord-item">
      <label>ç·¯åº¦</label>
      <input id="lat" readonly>
    </div>

    <div class="coord-item">
      <label>çµŒåº¦</label>
      <input id="lng" readonly>
    </div>
  </div>

<div id="map"></div>

<!-- é‡èœå -->
<label>é‡èœã®åå‰</label>
<input id="vegetable_name" placeholder="ä¾‹ï¼šã»ã†ã‚Œã‚“è‰">

<!-- å˜ä½ -->
<label>è²©å£²å˜ä½</label>
<input id="unit" placeholder="ä¾‹ï¼š1æŸ / 1è¢‹ / 1æœ¬">

<!-- ä¾¡æ ¼ -->
<label>ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
<input id="price" type="number" placeholder="ä¾‹ï¼š200">

<!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
<label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
<textarea id="comment" placeholder="ä¾‹ï¼šä»Šæœæ¡ã‚ŒãŸæ–°é®®ãªé‡èœã§ã™"></textarea>

<!-- å†™çœŸé¸æŠ -->
<label class="file-label">
  å†™çœŸã‚’æ’®ã‚‹ï¼é¸ã¶
  <input type="file"
         accept="image/*"
         capture="environment"
         id="photoInput">
</label>

<!-- å†™çœŸè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="photoPreview">
  <p>ã“ã“ã«å†™çœŸãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
</div>
<!-- â˜… æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨éƒ¨ã“ã“ã«å…¥ã‚Œã‚‹ã€€ãŠã‚ã‚Š -->
  <!--script script script script script script script script script script script scriptã€€ã¯ã˜ã¾ã‚Š--> 
<script>
document.getElementById("photoInput").addEventListener("change", function (event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function () {
    const preview = document.getElementById("photoPreview");
    preview.innerHTML = ""; // æ—¢å­˜ã®æ–‡å­—ã‚’æ¶ˆã™

    const img = document.createElement("img");
    img.src = reader.result;

    preview.appendChild(img);
  };

  reader.readAsDataURL(file);
});
</script>

<!--åœ°å›³è¡¨ç¤ºã‚’ã™ã‚‹-->
<script>
let map, marker;

function initMap(lat, lng) {
  map = L.map("map").setView([lat, lng], 15);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  marker = L.marker([lat, lng], { draggable: true }).addTo(map);

  marker.on("dragend", () => {
    const pos = marker.getLatLng();
    document.getElementById("lat").value = pos.lat.toFixed(6);
    document.getElementById("lng").value = pos.lng.toFixed(6);
  });
}

window.addEventListener("load", () => {
  initMap(34.452339, 131.764489);
});
</script>

<!-- åœ°å›³ç§»å‹• â˜…â˜…â˜… -->
  <script>
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          map.setView([lat, lng], 17);
          marker.setLatLng([lat, lng]);

          setTimeout(() => {
            map.invalidateSize();
          }, 100);
        },
        () => {
          alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      );
    }
  </script>
  <!--script script script script script script script script script script script scriptã€€ãŠã‚ã‚Šã€€-->

  <button onclick="registerVegetable()">ç™»éŒ²ã™ã‚‹</button>
  <!--script type="module"ã€€script type="module"ã€€script type="module"ã€€script type="module"ã¯ã˜ã¾ã‚Š--> 
<script type="module">
  //===== Supabase åˆæœŸè¨­å®š =====
  //è‡ªåˆ†ã® Supabase ã® URL ã¨ anon key ã‚’å…¥ã‚Œã¦ãã ã•ã„
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zyvpzobykvuscxuhsrad.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5dnB6b2J5a3Z1c2N4dWhzcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTE0NTAsImV4cCI6MjA4NTM2NzQ1MH0.Z2cKv3VSlk3iibQl7ldwcff9WF5cBHTZkcrdvxA2Bbk"
);

/* ===== â‘  ãƒ­ã‚°ã‚¤ãƒ³åˆ¶å¾¡ï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ï¼ï¼‰ ===== */
const appArea = document.getElementById("appArea");
const loginStatus = document.getElementById("loginStatus");
const logoutBtn = document.querySelector("button[onclick='logout()']");
console.log("Supabase OK", supabase);
appArea.classList.add("locked");

/* ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª */
const { data: { session } } = await supabase.auth.getSession();
if (session) enableApp(session.user);

/* ãƒ­ã‚°ã‚¤ãƒ³ */
window.login = async () => {
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailVal,
    password: passwordVal
  });

  if (error) {
    loginStatus.textContent = error.message;
    return;
  }

  enableApp(data.user);
};

/* æ–°è¦ç™»éŒ² */
window.signup = async () => {
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;

  const { error } = await supabase.auth.signUp({
    email: emailVal,
    password: passwordVal
  });

  if (error) {
    loginStatus.textContent = error.message;
    return;
  }

  loginStatus.textContent = "ç™»éŒ²å®Œäº†";
};

/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ */
window.logout = async () => {
  await supabase.auth.signOut();
  location.reload();
};

function enableApp(user) {
  appArea.classList.remove("locked");
  loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
  logoutBtn.classList.remove("hidden");
}
  //===== ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹ =====
function getCurrentLocation() {
  if (!navigator.geolocation) {
    alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“");
    return;
  }

  alert("é«˜ç²¾åº¦ã§ä½ç½®ã‚’å–å¾—ã—ã¾ã™ã€‚\nå‹•ã‹ãšã«æ•°ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚");

  let bestPosition = null;

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const accuracy = position.coords.accuracy;

      // ç²¾åº¦ãŒè‰¯ã„ã»ã©æ•°å€¤ã¯å°ã•ã„ï¼ˆä¾‹ï¼š5mï¼‰
      if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
        bestPosition = position;

        document.getElementById("lat").value =
          position.coords.latitude.toFixed(6);
        document.getElementById("lng").value =
          position.coords.longitude.toFixed(6);
      }

      // 10mä»¥ä¸‹ãªã‚‰ååˆ† â†’ ç›£è¦–çµ‚äº†
      if (accuracy <= 10) {
        navigator.geolocation.clearWatch(watchId);
        alert(`ä½ç½®ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆç²¾åº¦ ç´„${Math.round(accuracy)}mï¼‰`);
      }
    },
    (error) => {
      alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    },
    {
      enableHighAccuracy: true,
      timeout: 20000,
      maximumAge: 0
    }
  );

  const watchId = navigator.geolocation.watchPosition(()=>{});
}
  //===== é‡èœç™»éŒ²å‡¦ç† =====
async function registerVegetable() {

  // å…¥åŠ›å€¤ã‚’å–å¾—
  const farmName = document.getElementById("farm_name").value;
  const lat = document.getElementById("lat").value;
  const lng = document.getElementById("lng").value;
  const vegName = document.getElementById("vegetable_name").value;
  const unit = document.getElementById("unit").value;
  const price = document.getElementById("price").value;
  const comment = document.getElementById("comment").value;
  const file = document.getElementById("photoInput").files[0];

  // å¿…é ˆãƒã‚§ãƒƒã‚¯
  if (!farmName || !vegName || !price || !file) {
    alert("å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }
  //===== â‘  å†™çœŸã‚’ Supabase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
  const filePath = `vegetables/${Date.now()}_${file.name}`;

  const { error: uploadError } = await supabase
    .storage
    .from("images")
    .upload(filePath, file);

  if (uploadError) {
    alert("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }
  //===== â‘¡ ç”»åƒã®å…¬é–‹URLã‚’å–å¾— =====
  const { data: urlData } = supabase
    .storage
    .from("images")
    .getPublicUrl(filePath);

  const imageUrl = urlData.publicUrl;
  // ===== â‘¢ é‡èœãƒ‡ãƒ¼ã‚¿ã‚’ DB ã«ä¿å­˜ =====
  const { error: insertError } = await supabase
    .from("vegetables")
    .insert({
  //    farmer_id: user.id,        // ãƒ­ã‚°ã‚¤ãƒ³è¾²å®¶ID
      farm_name: farmName,
      latitude: lat,
      longitude: lng,
      vegetable_name: vegName,
      unit: unit,
      price: price,
      comment: comment,
      image_url: imageUrl,
      is_available: true
    });

  if (insertError) {
    alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  alert("é‡èœã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
  location.reload();
}

    window.getCurrentLocation = getCurrentLocation;// è¿½åŠ 
    window.registerVegetable = registerVegetable;// è¿½åŠ 

</script>
  <!--script type="module"ã€€script type="module"ã€€script type="module"ã€€script type="module"ãŠã‚ã‚Šã€€--> 
</body>
  <!--body body body body body body body body body body body body body body bodyã€€ãŠã‚ã‚Šã€€-->
</html>
