<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‡èœè³¼å…¥ï¼ˆäº‹æ¥­è€…ç”¨ï¼‰</title>

<style>
body {
  font-family: sans-serif;
  font-size: 18px;
  padding: 12px;
  background: #e1dbdb;
}

h1 {
  font-size: 24px;
  margin-bottom: 16px;
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  font-size: 18px;
  padding: 8px;
  margin: 6px 0 12px;
  max-width: 10cm;
}

.card {
  background: white;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 18px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);

  width: 13cm;        /* â† å›ºå®šå¹…ï¼ˆã“ã“é‡è¦ï¼‰ */
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}


.card img {
  width: 100%;
  height: 180px;      /* é«˜ã•å›ºå®š */
  object-fit: cover; /* åˆ‡ã‚ŠæŠœã„ã¦ãƒ•ã‚£ãƒƒãƒˆ */
  border-radius: 8px;
}


.name {
  font-size: 20px;
  font-weight: bold;
  margin-top: 8px;
}

.price {
  color: green;
  font-size: 18px;
  margin-top: 4px;
}

.comment {
  margin-top: 6px;
  color: #555;
}

button {
  margin-top: 10px;
  width: 100%;
  font-size: 18px;
  padding: 10px;
  background: #007700;
  color: white;
  border: none;
  border-radius: 6px;
  max-width: 6cm;
}

button:active {
  transform: translateY(2px);
}

#historyBtn {
  background: #006636;
  margin-bottom: 18px;
}

.card button {
  margin-top: 8px;
}

.card button:first-of-type {
  background: #5479b1;
}

.card button:last-of-type {
  margin-top: auto;   /* ä¸‹ã«æŠ¼ã—ä»˜ã‘ã‚‹ */
}

img {
  max-width: min(10cm, 100%);
  height: auto;
}

#list {
  display: flex;
  flex-wrap: wrap;        /* ã„ã£ã±ã„ã«ãªã£ãŸã‚‰æ¬¡ã®è¡Œã¸ */
  gap: 16px;              /* ã‚«ãƒ¼ãƒ‰åŒå£«ã®é–“éš” */
  align-items: stretch;   /* é«˜ã•ã‚’æƒãˆã‚‹ */
}


</style>
</head>

<body>

<h1>æœ¬æ—¥ã®é‡èœï¼ˆäº‹æ¥­è€…ç”¨ï¼‰</h1>

<button id="historyBtn">è³¼å…¥å±¥æ­´ã‚’è¦‹ã‚‹</button>


<label>è³¼å…¥è€…åï¼ˆäº‹æ¥­è€…åï¼‰</label>
<input id="buyer_name" placeholder="ä¾‹ï¼šå±±ç”°é’æœåº—">

<div id="list"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* Supabase æ¥ç¶š */
const supabase = createClient(
  "https://zyvpzobykvuscxuhsrad.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5dnB6b2J5a3Z1c2N4dWhzcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTE0NTAsImV4cCI6MjA4NTM2NzQ1MH0.Z2cKv3VSlk3iibQl7ldwcff9WF5cBHTZkcrdvxA2Bbk"
);

/*
  é‡èœä¸€è¦§å–å¾—
*/
async function loadVegetables() {
  const { data, error } = await supabase
    .from("vegetables")
    .select("*")
    .eq("is_available", true)
    .order("created_at", { ascending: false });

  if (error) {
    alert("é‡èœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  const list = document.getElementById("list");
  list.innerHTML = "";

  data.forEach(v => {
    const div = document.createElement("div");
    div.className = "card";

const mapUrl = `https://www.google.com/maps?q=${v.latitude},${v.longitude}`;

div.innerHTML = `
  <img src="${v.image_url}">
  <div class="name">${v.vegetable_name}</div>
  <div>${v.farm_name}</div>

  <button onclick="window.open('${mapUrl}', '_blank')">
    ğŸ“ ç•‘ã®å ´æ‰€
  </button>

  <div class="price">${v.price}å†† / ${v.unit}</div>
  <div class="comment">${v.comment || ""}</div>

  <label>è³¼å…¥æ•°é‡</label>
  <input type="number" min="1" value="1" id="qty_${v.id}">

  <button onclick="purchase('${v.id}')">è³¼å…¥ã—ã¾ã—ãŸ</button>
`;

    list.appendChild(div);
  });
}

/*
  è³¼å…¥å‡¦ç†
*/
async function purchase(vegetableId) {
//  const buyerId = document.getElementById("buyerId").value;
  const buyerName = document.getElementById("buyer_name").value;
//  const quantity  = document.getElementById("quantity").value;
  const qty = document.getElementById(`qty_${vegetableId}`).value;

if (!buyerName) {
    alert("è³¼å…¥è€…åï¼ˆäº‹æ¥­è€…åï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  if (!qty || qty <= 0) {
    alert("æ•°é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  /* purchases ã«è¨˜éŒ² */
  const { error } = await supabase
    .from("purchases")
    .insert({
      vegetable_id: vegetableId,
      buyer_name: buyerName,
      quantity: qty
    });

  if (error) {
    console.error(error);
    alert("è³¼å…¥è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  /* å£²åˆ‡ã‚Œæ‰±ã„ï¼ˆå˜å“è²©å£²å‰æï¼‰ */
  await supabase
    .from("vegetables")
    .update({ is_available: false })
    .eq("id", vegetableId);

  alert("è³¼å…¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
  loadVegetables();
}

window.purchase = purchase;

loadVegetables();

//buyer_history.htmlã«ç§»å‹•ã™ã‚‹
document.getElementById("historyBtn").onclick = () => {
  // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ buyer_history.html ã«ç§»å‹•
  window.location.href = "buyer_history.html";
};


</script>

</body>
</html>
